#!/bin/bash 

source $OPENSHIFT_CARTRIDGE_SDK_BASH

export PGCLIENT_REMOTE_PG_PORT=5432
export PGCLIENT_MASTER_PORT=15000
export PGCLIENT_STANDBY_PORT=15001
export PGCLIENT_LOADBAL_PORT=16000

echo $PGCLIENT_REMOTE_PG_PORT > $OPENSHIFT_PGCLIENT_DIR/env/PGCLIENT_REMOTE_PG_PORT
echo $PGCLIENT_MASTER_PORT > $OPENSHIFT_PGCLIENT_DIR/env/PGCLIENT_MASTER_PORT
echo $PGCLIENT_STANDBY_PORT > $OPENSHIFT_PGCLIENT_DIR/env/PGCLIENT_STANDBY_PORT
echo $PGCLIENT_LOADBAL_PORT > $OPENSHIFT_PGCLIENT_DIR/env/PGCLIENT_LOADBAL_PORT


if [ -n "$OPENSHIFT_JBOSSEWS_IP" ];
then
	client_result "pgclient adding datasources to jbossews context.xml"
	$OPENSHIFT_PGCLIENT_DIR/bin/setup-jbossews.sh
	$OPENSHIFT_JBOSSEWS_DIR/bin/control restart
fi

if [ -n "$OPENSHIFT_JBOSSEAP_IP" ];
then
        client_result "pgclient adding datasources to jbosseap standalone.xml"
        $OPENSHIFT_PGCLIENT_DIR/bin/setup-jbosseap.sh
fi

if [ -n "$PG_NODE_TYPE" ]; then
        client_result "$PG_NODE_TYPE is being setup"

        if [ "$PG_NODE_TYPE" == "master" ]; then
#    		add_domain_env_var "PG_MASTER_USER=${USER}"
#           add_domain_env_var "PG_MASTER_DNS=${OPENSHIFT_APP_DNS}"
#           add_domain_env_var "PG_MASTER_IP=${OPENSHIFT_PG_HOST}"
			echo "setup master node called"
        elif  [ "$PG_NODE_TYPE" == "standby" ]; then
#            add_domain_env_var "PG_STANDBY_USER=${USER}"
#			if [ -n "$PG_STANDBY_DNS" ];
#			then
#            	add_domain_env_var "PG_STANDBY_DNS=${OPENSHIFT_APP_DNS}:$PG_STANDBY_DNS"
#            	add_domain_env_var "PG_STANDBY_IP=${OPENSHIFT_PG_HOST}:$PG_STANDBY_IP"
#			else
#            	add_domain_env_var "PG_STANDBY_DNS=${OPENSHIFT_APP_DNS}"
#            	add_domain_env_var "PG_STANDBY_IP=${OPENSHIFT_PG_HOST}"
#			fi
			echo "setup standby node called"
        fi
fi

client_result "need to set PG_TUNNEL_PORTs!"
#echo "15000" > env/PG_TUNNEL_PORT

client_result "pgclient setup completed"
